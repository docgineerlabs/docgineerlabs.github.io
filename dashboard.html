<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .profile-pic-wrapper { position: relative; }
        .profile-pic-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; border-radius: 9999px; pointer-events: none; }
        main.edit-mode .profile-pic-wrapper { cursor: pointer; }
        main.edit-mode .profile-pic-wrapper:hover .profile-pic-overlay { opacity: 1; }
        main.edit-mode .profile-pic-overlay { pointer-events: auto; }
        input[type="file"] { display: none; }
        .edit-control { display: none !important; }
        main.edit-mode .edit-control { display: flex !important; }
        #sideMenu.is-open { transform: translateX(0); }
        #menuOverlay.is-open { opacity: 1; pointer-events: auto; }
        #hamburgerBtn .line { position: absolute; left: 50%; width: 24px; height: 2px; border-radius: 9999px; transition: all 0.3s ease-in-out; transform-origin: center; background-color: #475569; }
        #hamburgerBtn .line-top { transform: translate(-50%, -8px); }
        #hamburgerBtn .line-middle { transform: translate(-50%, 0); }
        #hamburgerBtn .line-bottom { transform: translate(-50%, 8px); }
        body.menu-is-open #hamburgerBtn .line-top { transform: translate(-50%, 0) rotate(45deg); }
        body.menu-is-open #hamburgerBtn .line-middle { opacity: 0; }
        body.menu-is-open #hamburgerBtn .line-bottom { transform: translate(-50%, 0) rotate(-45deg); }
        .edit-icon { display: none; margin-left: 8px; color: #64748b; }
        main.edit-mode .editable:hover .edit-icon { display: inline-block; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

<!-- Custom Notification Modal -->
<div id="notification-modal" class="fixed top-5 right-5 bg-white rounded-lg shadow-lg p-4 z-[200] hidden transform transition-transform translate-x-full ease-in-out duration-300">
    <div class="flex items-start">
        <div id="notification-icon" class="flex-shrink-0"></div>
        <div class="ml-3 w-0 flex-1 pt-0.5">
            <p id="notification-title" class="text-sm font-bold text-slate-900"></p>
            <p id="notification-message" class="mt-1 text-sm text-slate-600"></p>
        </div>
    </div>
</div>

<div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
    <p class="text-lg font-medium">Loading Profile...</p>
</div>
    <!-- Header Navigation -->
    <nav id="dashboard-header" class="fixed top-0 left-0 w-full z-40 transition-all duration-300 ease-in-out border-b border-transparent">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <span class="text-2xl font-bold text-slate-800">Docgineer Labs</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="saveProfileBtn" class="hidden bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">Save Profile</button>
                    <div class="relative z-50">
                         <button id="hamburgerBtn" class="icon-btn relative w-10 h-10 p-2 rounded-full text-slate-500 hover:text-slate-900 hover:bg-slate-100 transition-colors">
                            <span class="sr-only">Open menu</span>
                            <span class="line line-top"></span>
                            <span class="line line-middle"></span>
                            <span class="line line-bottom"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Employee Dashboard -->
    <main id="mainContainer" class="hidden">
        <div class="relative h-64 md:h-80 w-full">
            <img id="backgroundImage" src="https://placehold.co/1200x400/a5b4fc/1e293b?text=Cover+Photo" class="absolute inset-0 w-full h-full object-cover">
            <button id="changeBackgroundBtn" class="edit-control absolute top-20 right-4 bg-white/90 text-slate-800 px-3 py-1.5 rounded-md text-sm font-semibold hover:bg-white shadow">Change Cover</button>
        </div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
            <div class="relative bg-white rounded-xl shadow-lg p-6 md:p-8 -mt-24">
                <div class="flex flex-col sm:flex-row items-center sm:items-end mb-12">
                    <div class="flex-shrink-0 -mt-20">
                        <div id="profilePicContainer" class="profile-pic-wrapper h-32 w-32 md:h-40 md:w-40 border-4 border-white rounded-full bg-slate-200">
                            <img id="profileImage" class="h-full w-full rounded-full object-cover" src="https://placehold.co/200x200/e2e8f0/334155?text=Photo" alt="User profile picture">
                            <div class="profile-pic-overlay"><span>Change</span></div>
                        </div>
                    </div>
                    <div class="sm:ml-6 mt-4 sm:mt-0 text-center sm:text-left w-full">
                        <div class="editable flex items-center justify-center sm:justify-start">
                            <h2 id="userName" class="text-2xl md:text-3xl font-bold text-slate-900 focus:outline-none focus:bg-indigo-100 rounded px-2">User Name</h2>
                            <span class="edit-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></span>
                        </div>
                        <p class="text-slate-600 mt-1 flex items-center justify-center sm:justify-start editable">Position: <span id="userPosition" class="font-medium focus:outline-none focus:bg-indigo-100 rounded px-1 ml-1 text-slate-900">N/A</span><span class="edit-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></span></p>
                        <p class="text-slate-600 flex items-center justify-center sm:justify-start editable">Branch: <span id="userBranch" class="font-medium focus:outline-none focus:bg-indigo-100 rounded px-1 text-slate-900">N/A</span><span class="edit-icon"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></span></p>
                    </div>
                </div>
                <div class="mb-8"><div class="flex items-center border-b-2 border-slate-200 pb-2 mb-4 editable"><h3 class="text-2xl font-bold text-slate-900">About</h3><span class="edit-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></span></div><div id="aboutContentView"><p id="aboutText" class="text-slate-600 leading-relaxed whitespace-pre-wrap">Loading...</p></div><div id="aboutEditView" class="hidden"><textarea id="aboutTextarea" class="w-full h-32 p-2 border border-slate-300 rounded-md" rows="4"></textarea></div></div>
                <div class="mb-8"><div class="flex items-center border-b-2 border-slate-200 pb-2 mb-4 editable"><h3 class="text-2xl font-bold text-slate-900">Qualifications</h3><span class="edit-icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></span></div><div id="qualificationsContentView"><ul id="qualificationsList" class="list-disc list-inside space-y-2 text-slate-600"><li>Loading...</li></ul></div><div id="qualificationsEditView" class="hidden"><div id="qualificationsEditList" class="space-y-2"></div><button id="addQualificationBtn" class="edit-control mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-800">+ Add Qualification</button></div></div>
            </div>
        </div>
    </main>

    <!-- Member Dashboard -->
    <main id="memberContainer" class="hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 pt-24"> 
            <div class="relative bg-white rounded-xl shadow-lg p-6 md:p-8">
                <div class="flex flex-col items-center mb-12">
                    <div class="flex-shrink-0 mb-4">
                        <div id="memberProfilePicContainer" class="profile-pic-wrapper h-32 w-32 md:h-40 md:w-40 border-4 border-white rounded-full bg-slate-200">
                            <img id="memberProfileImage" class="h-full w-full rounded-full object-cover" src="https://placehold.co/200x200/e2e8f0/334155?text=Photo" alt="User profile picture">
                            <div class="profile-pic-overlay"><span>Change</span></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="flex items-center justify-center editable"><h2 id="memberName" class="text-2xl md:text-3xl font-bold text-slate-900 focus:outline-none focus:bg-indigo-100 rounded px-2">User Name</h2><span class="edit-icon ml-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></span></div>
                        <p id="memberEmail" class="text-slate-600 mt-1 font-medium">email@example.com</p>
                        <div class="text-slate-600 mt-1 flex items-center justify-center editable">Contact:<span id="memberContact" class="font-medium focus:outline-none focus:bg-indigo-100 rounded px-1 ml-1">N/A</span><span class="edit-icon ml-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></span></div>
                    </div>
                </div>
                <div class="mb-8"><div class="border-b-2 border-slate-200 pb-2 mb-4"><h3 class="text-2xl font-bold text-slate-900">Submit Your Idea</h3></div><form id="ideaForm" class="space-y-6 max-w-3xl mx-auto mt-8"><div><textarea id="ideaText" name="ideaText" rows="6" class="w-full p-3 border border-slate-300 rounded-md" placeholder="Describe your invention, project, or concept in detail..."></textarea></div><div><button type="submit" id="submitIdeaBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-md hover:bg-indigo-700">Submit</button></div></form>
                </div>
            </div>
        </div>
    </main>

    <div id="menuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>

    <div id="sideMenu" class="fixed top-0 right-0 h-full w-72 bg-white shadow-lg z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex justify-between items-center h-16 px-4 border-b border-slate-200 flex-shrink-0"><h3 class="font-bold text-lg text-slate-900">Menu</h3></div>
        <div class="flex-grow py-1 overflow-y-auto">
            <nav id="employeeNavLinks" class="hidden"><a href="https://meet.google.com/new" target="_blank" class="flex items-center px-4 py-3 text-sm text-slate-900 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-1.66-1.34-3-3-3H7c-1.66 0-3 1.34-3 3v10c0 1.66 1.34 3 3 3h7c1.66 0 3-1.34 3-3v-3.5l4 4v-11l-4 4z"/></svg><span>Google Meet</span></a><a href="#" id="employeeEditProfileBtn" class="flex items-center px-4 py-3 text-sm text-slate-900 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg><span>Edit Your profile</span></a><a href="/control_room.html" id="controlRoomLink" class="hidden flex items-center px-4 py-3 text-sm text-indigo-600 hover:bg-indigo-50 font-semibold"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>Control Room</span></a></nav>
            <nav id="memberNavLinks" class="hidden"><a href="https://meet.google.com/new" target="_blank" class="flex items-center px-4 py-3 text-sm text-slate-900 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-1.66-1.34-3-3-3H7c-1.66 0-3 1.34-3 3v10c0 1.66 1.34 3 3 3h7c1.66 0 3-1.34 3-3v-3.5l4 4v-11l-4 4z"/></svg><span>Google Meet</span></a><a href="#" id="memberEditProfileBtn" class="flex items-center px-4 py-3 text-sm text-slate-900 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg><span>Edit Your profile</span></a></nav>
        </div>
        <div class="flex-shrink-0 border-t border-slate-200"><a href="#" id="logoutBtn" class="flex items-center px-4 py-3 text-sm text-slate-900 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg><span>Logout</span></a></div>
    </div>
    <input type="file" id="profilePicInput" accept="image/*">
    <input type="file" id="backgroundPicInput" accept="image/*">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, addDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyB1n-RkiDibKhlc9tOE-G-Hpz4zA8LuQGA",
        authDomain: "docgineerlabs-b4830.firebaseapp.com",
        projectId: "docgineerlabs-b4830",
        storageBucket: "docgineerlabs-b4830.appspot.com",
        messagingSenderId: "338822276527",
        appId: "1:338822276527:web:271e8761eaabcc79e8fb5a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    document.addEventListener('DOMContentLoaded', () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        const employeeContainer = document.getElementById('mainContainer');
        const memberContainer = document.getElementById('memberContainer');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const logoutBtn = document.getElementById('logoutBtn');
        const employeeNavLinks = document.getElementById('employeeNavLinks');
        const memberNavLinks = document.getElementById('memberNavLinks');
        const employeeEditProfileBtn = document.getElementById('employeeEditProfileBtn');
        const memberEditProfileBtn = document.getElementById('memberEditProfileBtn');
        const header = document.getElementById('dashboard-header');
        
        let currentUserRole = null;
        let currentUserId = null;
        let isEditing = false; 

        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const notificationIcon = document.getElementById('notification-icon');

        function showNotification(title, message, isError = false) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationIcon.innerHTML = isError 
                ? `<svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`
                : `<svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            notificationModal.classList.remove('hidden', 'translate-x-full');
            notificationModal.classList.add('translate-x-0');
            setTimeout(() => {
                notificationModal.classList.remove('translate-x-0');
                notificationModal.classList.add('translate-x-full');
                setTimeout(() => notificationModal.classList.add('hidden'), 300);
            }, 4000);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                await loadUserProfile(user.uid);
            } else {
                window.location.href = '/index.html';
            }
        });

        async function loadUserProfile(userId) {
            const userDocRef = doc(db, "users", userId);
            try {
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    currentUserRole = userData.role || 'employee';
                    
                    enterViewMode(); // Always lock the UI before loading data

                    if (currentUserRole === 'member') {
                        memberContainer.classList.remove('hidden');
                        employeeContainer.classList.add('hidden');
                        memberNavLinks.classList.remove('hidden');
                        employeeNavLinks.classList.add('hidden');
                        
                        document.getElementById('memberName').textContent = userData.fullName || 'User Name';
                        document.getElementById('memberEmail').textContent = userData.email || 'No email';
                        document.getElementById('memberContact').textContent = userData.contactPhone || 'N/A';
                        if (userData.profileImageUrl) document.getElementById('memberProfileImage').src = userData.profileImageUrl;
                    } else { 
                        employeeContainer.classList.remove('hidden');
                        memberContainer.classList.add('hidden');
                        employeeNavLinks.classList.remove('hidden');
                        memberNavLinks.classList.add('hidden');
                        
                        const controlRoomLink = document.getElementById('controlRoomLink');
                        if (userData.position === 'Founder and CEO' && controlRoomLink) {
                            controlRoomLink.classList.remove('hidden');
                        }
                    
                        document.getElementById('userName').textContent = userData.fullName || 'User Name';
                        document.getElementById('userPosition').textContent = userData.position || 'N/A';
                        document.getElementById('userBranch').textContent = userData.branch || 'N/A';
                        document.getElementById('aboutText').textContent = userData.about || 'No information provided.';
                        if (userData.profileImageUrl) document.getElementById('profileImage').src = userData.profileImageUrl;
                        if (userData.coverImageUrl) document.getElementById('backgroundImage').src = userData.coverImageUrl;

                        const qualificationsList = document.getElementById('qualificationsList');
                        qualificationsList.innerHTML = '';
                        if (userData.qualifications && userData.qualifications.length > 0) {
                            userData.qualifications.forEach(q => {
                                const li = document.createElement('li');
                                li.textContent = q;
                                qualificationsList.appendChild(li);
                            });
                        } else {
                            qualificationsList.innerHTML = '<li>No qualifications listed.</li>';
                        }
                    }
                    
                    loadingOverlay.style.display = 'none';

                } else { throw new Error("User profile not found in database."); }
            } catch(error) {
                console.error("Error loading user profile:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500">Error loading profile. Redirecting...</p>';
                setTimeout(() => { window.location.href = '/index.html' }, 3000);
            }
        }
        
        const ideaForm = document.getElementById('ideaForm');
        ideaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const ideaDescription = document.getElementById('ideaText').value.trim();
            if (!ideaDescription) { showNotification('Error', 'Please describe your idea before submitting.', true); return; }
            const submitIdeaBtn = document.getElementById('submitIdeaBtn');
            submitIdeaBtn.disabled = true; submitIdeaBtn.textContent = 'Submitting...';
            try {
                await addDoc(collection(db, "ideaSubmissions"), {
                    userId: currentUserId,
                    userName: document.getElementById('memberName').textContent,
                    userEmail: document.getElementById('memberEmail').textContent,
                    description: ideaDescription,
                    submittedAt: serverTimestamp(),
                    status: 'new'
                });
                showNotification('Success', 'Thank you! Your idea has been submitted.');
                ideaForm.reset();
            } catch (error) { console.error("Error submitting idea: ", error); showNotification('Error', 'There was an error submitting your idea.', true); } 
            finally { submitIdeaBtn.disabled = false; submitIdeaBtn.textContent = 'Submit Idea'; }
        });
        
        function enterViewMode() {
            isEditing = false;
            saveProfileBtn.classList.add('hidden');
            
            employeeContainer.classList.remove('edit-mode');
            memberContainer.classList.remove('edit-mode');

            document.getElementById('userName').contentEditable = false;
            document.getElementById('userBranch').contentEditable = false;
            document.getElementById('memberName').contentEditable = false;
            document.getElementById('memberContact').contentEditable = false;

            document.getElementById('aboutContentView').classList.remove('hidden');
            document.getElementById('aboutEditView').classList.add('hidden');
            document.getElementById('qualificationsContentView').classList.remove('hidden');
            document.getElementById('qualificationsEditView').classList.add('hidden');
        }

        function handleEditProfile() {
             if (isEditing) return;
             isEditing = true;
             saveProfileBtn.classList.remove('hidden');
             const activeContainer = currentUserRole === 'member' ? memberContainer : employeeContainer;
             activeContainer.classList.add('edit-mode');

             if (currentUserRole === 'member') {
                 document.getElementById('memberName').contentEditable = true;
                 document.getElementById('memberContact').contentEditable = true;
             } else {
                document.getElementById('userName').contentEditable = true;
                document.getElementById('userBranch').contentEditable = true;
                document.getElementById('aboutTextarea').value = document.getElementById('aboutText').textContent.trim();
                document.getElementById('aboutContentView').classList.add('hidden');
                document.getElementById('aboutEditView').classList.remove('hidden');

                const qualificationsEditList = document.getElementById('qualificationsEditList');
                qualificationsEditList.innerHTML = '';
                 document.querySelectorAll('#qualificationsList li').forEach(item => {
                     if (item.textContent !== 'No qualifications listed.') createQualificationInput(item.textContent);
                 });
                document.getElementById('qualificationsContentView').classList.add('hidden');
                document.getElementById('qualificationsEditView').classList.remove('hidden');
             }
        }

        async function handleSaveProfile() {
            if (!isEditing || !currentUserId) return;
            saveProfileBtn.disabled = true; 
            saveProfileBtn.textContent = 'Saving...';
            
            const profilePicFile = document.getElementById('profilePicInput').files[0];
            const backgroundPicFile = document.getElementById('backgroundPicInput').files[0];

            try {
                const updatedData = {};
                if (profilePicFile) {
                    const profileImageRef = ref(storage, `profileImages/${currentUserId}`);
                    await uploadBytes(profileImageRef, profilePicFile);
                    updatedData.profileImageUrl = await getDownloadURL(profileImageRef);
                }

                if (currentUserRole === 'member') {
                    updatedData.fullName = document.getElementById('memberName').textContent.trim();
                    updatedData.contactPhone = document.getElementById('memberContact').textContent.trim();
                } else {
                    if (backgroundPicFile) {
                        const coverImageRef = ref(storage, `coverImages/${currentUserId}`);
                        await uploadBytes(coverImageRef, backgroundPicFile);
                        updatedData.coverImageUrl = await getDownloadURL(coverImageRef);
                    }
                    updatedData.fullName = document.getElementById('userName').textContent.trim();
                    updatedData.branch = document.getElementById('userBranch').textContent.trim();
                    updatedData.about = document.getElementById('aboutTextarea').value.trim();
                    updatedData.qualifications = Array.from(document.querySelectorAll('#qualificationsEditList input')).map(input => input.value.trim()).filter(Boolean);
                }

                await updateDoc(doc(db, "users", currentUserId), updatedData);
                
                enterViewMode(); 
                
                showNotification('Success', 'Profile updated successfully!');
                loadUserProfile(currentUserId); 

            } catch (error) { 
                console.error("Error updating profile: ", error); 
                showNotification('Error', 'Failed to update profile.', true); 
            } finally { 
                saveProfileBtn.disabled = false; 
                saveProfileBtn.textContent = 'Save Profile'; 
            }
        }
        
        function createQualificationInput(value = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            const input = document.createElement('input');
            input.type = 'text'; input.value = value; input.className = 'w-full p-1 border border-slate-300 rounded-md';
            const removeBtn = document.createElement('button');
            removeBtn.textContent = '×'; removeBtn.className = 'text-red-500 font-bold text-xl';
            removeBtn.onclick = () => div.remove();
            div.appendChild(input); div.appendChild(removeBtn);
            document.getElementById('qualificationsEditList').appendChild(div);
        }

        document.getElementById('addQualificationBtn').addEventListener('click', () => createQualificationInput());

        const setupImageUpload = (containerId, inputId, isMember) => {
             const container = document.getElementById(containerId);
             const input = document.getElementById(inputId);
             container.addEventListener('click', () => { if(isEditing) input.click() });
             input.addEventListener('change', (event) => {
                 if (event.target.files && event.target.files[0]) {
                     const reader = new FileReader();
                     reader.onload = (e) => {
                         const img = isMember ? document.getElementById('memberProfileImage') : document.getElementById('profileImage');
                         if(img) img.src = e.target.result;
                     }
                     reader.readAsDataURL(event.target.files[0]);
                 }
             });
        };
        setupImageUpload('profilePicContainer', 'profilePicInput', false);
        setupImageUpload('memberProfilePicContainer', 'profilePicInput', true);
        
        document.getElementById('changeBackgroundBtn').addEventListener('click', () => { if(isEditing) document.getElementById('backgroundPicInput').click() });
        document.getElementById('backgroundPicInput').addEventListener('change', (event) => {
             if (event.target.files && event.target.files[0]) {
                 const reader = new FileReader();
                 reader.onload = (e) => { document.getElementById('backgroundImage').src = e.target.result; }
                 reader.readAsDataURL(event.target.files[0]);
             }
        });

        function closeMenu() { document.body.classList.remove('menu-is-open'); sideMenu.classList.remove('is-open'); menuOverlay.classList.remove('is-open'); }
        hamburgerBtn.addEventListener('click', (e) => { e.stopPropagation(); document.body.classList.toggle('menu-is-open'); sideMenu.classList.toggle('is-open'); menuOverlay.classList.toggle('is-open'); });
        menuOverlay.addEventListener('click', closeMenu);
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth).catch((error) => console.error('Logout error:', error)); });
        memberEditProfileBtn.addEventListener('click', (e) => { e.preventDefault(); closeMenu(); handleEditProfile(); });
        employeeEditProfileBtn.addEventListener('click', (e) => { e.preventDefault(); closeMenu(); handleEditProfile(); });
        saveProfileBtn.addEventListener('click', handleSaveProfile);

        window.addEventListener('scroll', () => {
             if (window.scrollY > 50) header.classList.add('backdrop-blur-sm', 'bg-white/80', 'border-slate-200');
             else header.classList.remove('backdrop-blur-sm', 'bg-white/80', 'border-slate-200');
        });
    });
</script>
</body>
</html>


