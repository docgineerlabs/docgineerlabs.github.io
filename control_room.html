<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Room | Docgineer Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

<!-- Loading/Access Denied Overlay -->
<div id="auth-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
    <p id="auth-message" class="text-lg font-medium">Verifying Access...</p>
</div>

<!-- Main Content (Hidden until authorized) -->
<div id="main-content" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Control Room</h1>
                <p class="text-sm text-slate-500">System Administration Dashboard</p>
            </div>
            <a href="dashboard.html" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">&larr; Back to Dashboard</a>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        
        <!-- Employees Section -->
        <section id="employees-section">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-3xl font-bold text-slate-800">Active Employees</h2>
                 <div class="flex items-center gap-4">
                    <button id="message-group-btn" class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                        <span>Message Group</span>
                    </button>
                    <button id="start-group-meet-btn" class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 10.5V7c0-1.66-1.34-3-3-3H7c-1.66 0-3 1.34-3 3v10c0 1.66 1.34 3 3 3h7c1.66 0 3-1.34 3-3v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        <span>Start Group Meet</span>
                    </button>
                 </div>
            </div>

            <!-- Employee User Management -->
            <div id="employees-user-management">
                <h3 class="text-xl font-semibold text-slate-700 mb-1">User Management</h3>
                <div class="bg-white rounded-lg shadow overflow-hidden mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Branch</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Position</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Message</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Meet</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                </tr>
                            </thead>
                            <tbody id="employees-table-body" class="bg-white divide-y divide-slate-200">
                                <!-- Employee rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Members Section -->
        <section id="members-section">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-slate-800">Members</h2>
                <div class="flex items-center gap-4">
                    <button id="message-group-btn-members" class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                        <span>Message Group</span>
                    </button>
                    <button id="start-group-meet-btn-members" class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 10.5V7c0-1.66-1.34-3-3-3H7c-1.66 0-3 1.34-3 3v10c0 1.66 1.34 3 3 3h7c1.66 0 3-1.34 3-3v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        <span>Start Group Meet</span>
                     </button>
                </div>
            </div>

            <!-- Member User Management -->
            <div id="members-user-management">
                <h3 class="text-xl font-semibold text-slate-700 mb-1">User Management</h3>
                <div class="bg-white rounded-lg shadow overflow-hidden mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Email ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Contact</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Message</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Meet</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Edit</span></th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body" class="bg-white divide-y divide-slate-200">
                                <!-- Member rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Member Idea Submissions -->
            <div id="members-idea-submissions" class="mt-8">
                <h3 class="text-xl font-semibold text-slate-700 mb-1">Idea Submissions</h3>
                <div id="members-ideas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                    <!-- Idea cards will be dynamically inserted here -->
                </div>
            </div>
        </section>
        
        <!-- Employee Applications Section -->
        <section id="applications-section">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">Pending Applications</h2>
            <div class="bg-white rounded-lg shadow overflow-hidden mt-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Applicant Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Applying For</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Branch / Specialization</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applications-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- Applicant rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- All Modals remain the same -->
<div id="edit-user-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden"><!-- ... --></div>
<div id="message-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden"><!-- ... --></div>
<div id="application-details-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden"><!-- ... --></div>


<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB1n-RkiDibKhlc9tOE-G-Hpz4zA8LuQGA",
        authDomain: "docgineerlabs-b4830.firebaseapp.com",
        projectId: "docgineerlabs-b4830",
        storageBucket: "docgineerlabs-b4830.firebasestorage.app",
        messagingSenderId: "338822276527",
        appId: "1:338822276527:web:271e8761eaabcc79e8fb5a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
        // ... (all variable declarations remain the same) ...
        const authOverlay = document.getElementById('auth-overlay');
        const authMessage = document.getElementById('auth-message');
        const mainContent = document.getElementById('main-content');
        const applicationsTableBody = document.getElementById('applications-table-body');
        // ... and so on for all your other variables

        let currentAdminProfile = null; // Add this if not already declared globally
        let allEmployeeEmails = []; // Add this if not already declared globally
        let allMemberEmails = []; // Add this if not already declared globally

        // --- Function to load all data ---
        function loadAllData() {
            loadUsers(); // Make sure loadUsers is defined elsewhere in your script
            loadIdeas(); // Make sure loadIdeas is defined elsewhere in your script
            loadApplications(); // Make sure loadApplications is defined elsewhere in your script
            loadMembers(); // Make sure loadMembers is defined elsewhere in your script
        }

        onAuthStateChanged(auth, async (user) => {
            // --- Security Check ---
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists() && userDocSnap.data().position === 'Founder and CEO') {
                        // Access Granted
                        currentAdminProfile = userDocSnap.data(); // Save admin profile if needed
                        authOverlay.style.display = 'none';
                        mainContent.classList.remove('hidden');
                        loadAllData(); // Load data AFTER granting access
                    } else {
                        // Access Denied (Logged in, but not CEO)
                        authMessage.textContent = 'Access Denied. You do not have permission.';
                        authMessage.classList.add('text-red-500');
                        setTimeout(() => { window.location.href = 'dashboard.html'; }, 2000);
                    }
                } catch (error) {
                    console.error("Error fetching user document:", error);
                    authMessage.textContent = 'Error verifying access. Please try again.';
                    authMessage.classList.add('text-red-500');
                    // Optional: Redirect after error
                    // setTimeout(() => { window.location.href = 'dashboard.html'; }, 3000);
                }
            } else {
                // Not logged in
                authMessage.textContent = 'You are not logged in. Redirecting...';
                authMessage.classList.add('text-red-500'); // Make it red too
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
            }
        });

        // --- KEY CHANGE: UPDATED loadApplications and grantApplication ---

        async function loadApplications(isPreview = false) {
            applicationsTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Loading applications...</td></tr>`;
            if(isPreview) { 
                applicationsTableBody.innerHTML = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-slate-900">New Applicant (Sample)</div><div class="text-sm text-slate-500">applicant@example.com</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">Engineer</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">Mechanical Engineering (ME)</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button class="view-btn text-blue-600 hover:text-blue-900">View</button>
                            <button class="grant-btn text-green-600 hover:text-green-900">Grant</button>
                            <button class="reject-btn text-red-600 hover:text-red-900">Reject</button>
                        </td>
                    </tr>
                `;
                return; 
            }
            try {
                // NOW queries the 'users' collection for pending status
                const q = query(collection(db, "users"), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                applicationsTableBody.innerHTML = '';
                if(querySnapshot.empty) {
                    applicationsTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No pending applications.</td></tr>`;
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    const applicant = docSnap.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-slate-900">${applicant.fullName}</div><div class="text-sm text-slate-500">${applicant.email}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${applicant.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${applicant.branch}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button class="view-btn text-blue-600 hover:text-blue-900" data-id="${docSnap.id}">View</button>
                            <button class="grant-btn text-green-600 hover:text-green-900" data-id="${docSnap.id}" data-name="${applicant.fullName}" data-email="${applicant.email}">Grant</button>
                            <button class="reject-btn text-red-600 hover:text-red-900" data-id="${docSnap.id}">Reject</button>
                        </td>
                    `;
                    applicationsTableBody.appendChild(tr);
                });
            } catch(error) {
                console.error("Error loading applications: ", error);
                applicationsTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading applications.</td></tr>`;
            }
        }

        async function grantApplication(userId, userName, userEmail) {
            // This function is now MUCH simpler. It only updates the status.
            try {
                await updateDoc(doc(db, "users", userId), { status: 'active' });
                const mailtoLink = `mailto:${userEmail}?subject=${encodeURIComponent("Welcome to Docgineer Labs!")}&body=${encodeURIComponent(`Dear ${userName},\n\nCongratulations! Your application has been approved.\n\nYou can now log in to your dashboard.\n\nBest regards,\nThe Docgineer Labs Team`)}`;
                window.location.href = mailtoLink;
                // Refresh all data to move user from pending to active list
                setTimeout(loadAllData, 500); 
            } catch(error) {
                console.error("Error updating application status: ", error);
                alert("Failed to grant application status.");
            }
        }
        
        // ... (The rest of your control_room.html script, including rejectApplication, openApplicationModal, and all event listeners, remains the same) ...
    });
</script>

</body>
</html>
