<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Room | Docgineer Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        #reply-textarea {
    resize: none;
    overflow-y: hidden;
    max-height: 120px; /* Limit max height */
}
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

<!-- Loading/Access Denied Overlay -->
<div id="auth-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
    <p id="auth-message" class="text-lg font-medium">Verifying Access...</p>
</div>

<!-- Main Content (Hidden until authorized) -->
<div id="main-content" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Control Room</h1>
                <p class="text-sm text-slate-500">System Administration Dashboard</p>
            </div>
            <a href="dashboard.html" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">&larr; Back to Dashboard</a>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        
        <!-- Employees Section -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <h2 class="text-3xl font-bold text-slate-800">Active Employees</h2>
    
    <div class="flex flex-col gap-2 bg-white p-3 rounded-lg shadow-sm border border-slate-200">
        <div class="flex justify-between items-center">
            <label class="text-xs font-bold text-slate-500 uppercase">Meeting Room</label>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="meet-toggle" class="sr-only peer">
                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                <span class="ml-2 text-xs font-bold text-gray-700 w-6" id="meet-status-text">OFF</span>
            </label>
        </div>
        <div class="flex gap-2">
            <input type="text" id="permanent-link-input" placeholder="Paste Google Meet URL" class="text-sm border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-64 p-1 border">
            <button id="update-link-btn" class="bg-slate-800 text-white px-3 py-1 rounded-md text-xs font-bold hover:bg-black">UPDATE</button>
        </div>
    </div>

    <div class="flex items-center gap-4">
        <button id="message-group-btn" class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-600 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
            </svg>
            <span>Message Group</span>
        </button>
        
        <button id="start-employee-meet-btn" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors font-medium text-sm">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
    </svg>
    Start Group Meet
</button>
    </div>
</div>

            <!-- Employee User Management -->
            <div id="employees-user-management">
                <h3 class="text-xl font-semibold text-slate-700 mb-1">User Management</h3>
                <div class="bg-white rounded-lg shadow overflow-hidden mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name & Email</th>
                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Branch</th>
                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Position</th>
                                  <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Message</th>
                                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Private Meet</th>
                                  <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span>
                                  </th>
                            </thead>
                            <tbody id="employees-table-body" class="bg-white divide-y divide-slate-200">
                                <!-- Employee rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Members Section -->
        <section id="members-section">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-slate-800">Members</h2>
                
                <div class="flex flex-col gap-2 bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-slate-500 uppercase">Meeting Room</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="member-meet-toggle" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ml-2 text-xs font-bold text-gray-700 w-6" id="member-meet-status-text">OFF</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="member-permanent-link-input" placeholder="Paste Member Meet URL" class="text-sm border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 w-64 p-1 border">
                        <button id="member-update-link-btn" class="bg-slate-800 text-white px-3 py-1 rounded-md text-xs font-bold hover:bg-black">UPDATE</button>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button id="message-group-btn-members" class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                        <span>Message Group</span>
                    </button>
                    <button id="start-group-meet-btn-members" class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 10.5V7c0-1.66-1.34-3-3-3H7c-1.66 0-3 1.34-3 3v10c0 1.66 1.34 3 3 3h7c1.66 0 3-1.34 3-3v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        <span>Start Group Meet</span>
                      </button>
                </div>
            </div>

            <!-- Member User Management -->
            <div id="members-user-management">
                <h3 class="text-xl font-semibold text-slate-700 mb-1">User Management</h3>
                <div class="bg-white rounded-lg shadow overflow-hidden mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name & Email</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Contact</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Message</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Private Meet</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body" class="bg-white divide-y divide-slate-200">
                                <!-- Member rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Member Idea Submissions -->
            <div id="members-idea-submissions" class="mt-8">
                <h3 class="text-xl font-semibold text-slate-700 mb-1">Idea Submissions</h3>
                <div id="members-ideas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                    <!-- Idea cards will be dynamically inserted here -->
                </div>
            </div>
        </section>
        
        <!-- Employee Applications Section -->
        <section id="applications-section">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">Pending Applications</h2>
            <div class="bg-white rounded-lg shadow overflow-hidden mt-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Applicant Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Applying For</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Branch / Specialization</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applications-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- Applicant rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Edit User Modal -->
<div id="edit-user-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
        <div class="p-5 border-b border-slate-200 flex justify-between items-center">
            <h3 class="text-lg font-bold text-slate-900">Edit User Details</h3>
            <button id="edit-modal-close-btn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 space-y-4">
            <div>
                <label for="edit-full-name" class="block text-sm font-medium text-slate-700">Full Name</label>
                <input type="text" id="edit-full-name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
            </div>
            <div>
                <label for="edit-position" class="block text-sm font-medium text-slate-700">Position</label>
                <input type="text" id="edit-position" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
            </div>
            <div>
                <label for="edit-branch" class="block text-sm font-medium text-slate-700">Branch / Specialization</label>
                <input type="text" id="edit-branch" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
            </div>
        </div>
        <div class="p-5 bg-slate-50 border-t border-slate-200 text-right">
            <button id="save-changes-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- 
  --- NEW MESSAGE MODAL ---
  (Replaces the old one)
-->
<div id="message-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        
        <!-- Modal Header -->
        <div class="p-5 border-b border-slate-200 flex justify-between items-center flex-shrink-0">
            <h3 id="message-modal-title" class="text-lg font-bold text-slate-900">Send Message</h3>
            <button id="message-modal-close-btn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
        </div>

        <!-- Message Display Area (Chat Bubbles) -->
        <div id="messages-container" class="p-4 space-y-3 overflow-y-auto flex-grow flex flex-col bg-slate-50">
            <!-- Messages will be injected here -->
            <p id="no-messages-text" class="text-slate-500 text-center">No messages yet.</p>
        </div>

        <!-- New Reply Bar -->
        <div id="reply-section" class="p-3 border-t border-slate-200 bg-white flex-shrink-0 flex items-center gap-2">
    
            <!-- Attach Options (Paperclip) -->
            <button id="attach-file-btn" title="Attach file" class="flex-shrink-0 h-10 w-10 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a4 4 0 00-5.656-5.656l-6.415 6.415a6 6 0 008.485 8.485l6.586-6.586"></path></svg>
            </button>
            
            <!-- Camera Option -->
            <button id="camera-btn" title="Use camera" class="flex-shrink-0 h-10 w-10 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        
            <!-- Text Input Area (Resizes) -->
            <div class="flex-grow relative">
                <!-- Note: The ID is now 'reply-textarea' -->
                <textarea id="reply-textarea" rows="1" class="block w-full rounded-2xl border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5 px-4" placeholder="Type a message..." oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'"></textarea>
            </div>
        
            <!-- Voice Recording (Mic) -->
            <button id="mic-btn" title="Record voice" class="flex-shrink-0 h-10 w-10 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
            </button>
        
            <!-- Send Button (Icon) -->
            <!-- Note: The ID is now 'send-message-btn' -->
            <button id="send-message-btn" title="Send message" class="flex-shrink-0 h-10 w-10 flex items-center justify-center rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.571V11.5a1 1 0 012 0v5.071a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
            </button>
        </div>

    </div>
</div>
<!-- --- END OF NEW MESSAGE MODAL --- -->


<!-- Application Details Modal -->
<div id="application-details-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-slate-200 sticky top-0 bg-white z-10">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-slate-900">Applicant Details</h3>
                    <p id="modal-applicant-name" class="text-sm text-slate-600"></p>
                </div>
                <button id="modal-close-btn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
        </div>
        <div class="p-6 space-y-6">
            <div>
                <h4 class="font-semibold text-slate-700">Role & Specialization</h4>
                <p id="modal-applicant-role" class="mt-1 text-sm text-slate-600"></p>
            </div>
            <div>
                <h4 class="font-semibold text-slate-700">About</h4>
                <p id="modal-applicant-about" class="mt-1 text-sm text-slate-600 whitespace-pre-wrap"></p>
            </div>
            <div>
                <h4 class="font-semibold text-slate-700">Skills</h4>
                <p id="modal-applicant-skills" class="mt-1 text-sm text-slate-600 whitespace-pre-wrap"></p>
            </div>
            <div>
                <h4 class="font-semibold text-slate-700">Work / Research</h4>
                <p id="modal-applicant-work" class="mt-1 text-sm text-slate-600 whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>
</div>
<div id="broadcast-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 z-[60] flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
        <div class="p-5 border-b border-slate-200">
            <h3 class="text-lg font-bold text-slate-900">Broadcast Meeting</h3>
        </div>
        <div class="p-5 space-y-4">
            <p class="text-sm text-slate-600">
                1. A Google Meet tab has been opened.<br>
                2. Copy the meeting link from that tab.<br>
                3. Paste it below to send it to all users.
            </p>
            <div>
                <label for="meet-link-input" class="block text-sm font-medium text-slate-700">Meeting Link</label>
                <input type="text" id="meet-link-input" placeholder="https://meet.google.com/..." class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
            </div>
        </div>
        <div class="p-5 bg-slate-50 border-t border-slate-200 flex justify-end gap-2">
            <button id="cancel-broadcast-btn" class="text-slate-600 hover:text-slate-900 px-4 py-2 text-sm font-medium">Cancel</button>
            <button id="confirm-broadcast-btn" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">Broadcast Link</button>
        </div>
    </div>
</div>

<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, query, where, addDoc, serverTimestamp, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB1n-RkiDibKhlc9tOE-G-Hpz4zA8LuQGA",
        authDomain: "docgineerlabs-b4830.firebaseapp.com",
        projectId: "docgineerlabs-b4830",
        storageBucket: "docgineerlabs-b4830.firebasestorage.app",
        messagingSenderId: "338822276527",
        appId: "1:338822276527:web:271e8761eaabcc79e8fb5a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
        const authOverlay = document.getElementById('auth-overlay');
        const authMessage = document.getElementById('auth-message');
        const mainContent = document.getElementById('main-content');
        
        const applicationsTableBody = document.getElementById('applications-table-body');
        const employeesTableBody = document.getElementById('employees-table-body');
        const membersTableBody = document.getElementById('members-table-body');
        const membersIdeasContainer = document.getElementById('members-ideas-container');

        // Modals
        const messageModal = document.getElementById('message-modal');
        const applicationDetailsModal = document.getElementById('application-details-modal');
        const editUserModal = document.getElementById('edit-user-modal');

        // Modal Buttons
        const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const editModalCloseBtn = document.getElementById('edit-modal-close-btn');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        
        // Non-Modal Buttons
        const messageGroupBtn = document.getElementById('message-group-btn');
        const messageGroupBtnMembers = document.getElementById('message-group-btn-members');
        const startGroupMeetBtn = document.getElementById('start-group-meet-btn');
        const startGroupMeetBtnMembers = document.getElementById('start-group-meet-btn-members');

        // Edit Modal Form Fields
        const editFullName = document.getElementById('edit-full-name');
        const editPosition = document.getElementById('edit-position');
        const editBranch = document.getElementById('edit-branch');

        // Global state
        let currentAdminProfile = null;
        let messageRecipient = { id: null, name: null };
        let editingUser = { id: null, role: null };
        let allEmployeeEmails = [];
        let allMemberEmails = [];

        onAuthStateChanged(auth, async (user) => {
            const isPreviewMode = !auth.currentUser;
            if (isPreviewMode) {
                 authOverlay.style.display = 'none';
                 mainContent.classList.remove('hidden');
                 loadUsers(true);
                 loadIdeas(true);
                 loadApplications(true);
                 loadMembers(true);
            } else {
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists() && userDocSnap.data().position === 'Founder and CEO') {
                        currentAdminProfile = userDocSnap.data();
                        authOverlay.style.display = 'none';
                        mainContent.classList.remove('hidden');
                        loadAllData();
                    } else {
                        authMessage.textContent = 'Access Denied. Redirecting...';
                        authMessage.classList.add('text-red-500');
                        setTimeout(() => { window.location.href = 'dashboard.html'; }, 2000);
                    }
                } catch (e) {
                    authMessage.textContent = 'You are not logged in. Redirecting...';
                    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                }
            }
        });

        function loadAllData() {
            loadUsers();
            loadIdeas();
            loadApplications();
            loadMembers();
        }
        
        async function loadApplications(isPreview = false) {
             applicationsTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">Loading applications...</td></tr>`;
             if(isPreview) { 
                 const mailtoLink = "mailto:applicant@example.com?subject=Update%20on%20your%20Docgineer%20Labs%20Application&body=Dear%20New%20Applicant%20(Sample)%2C%0A%0AThank%20you%20for%20your%20interest%20in%20Docgineer%20Labs.%20We%20are%20currently%20reviewing%20your%20application%20and%20will%20get%20back%20to%20you%20shortly.%0A%0ABest%20regards%2C%0AThe%20Docgineer%20Labs%20Team";
                 applicationsTableBody.innerHTML = `
                     <tr>
                         <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-slate-900">New Applicant (Sample)</div><div class="text-sm text-slate-500">applicant@example.com</div></td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">Engineer</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">Mechanical Engineering (ME)</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                             <button class="view-btn text-blue-600 hover:text-blue-900">View</button>
                             <button class="grant-btn text-green-600 hover:text-green-900">Grant</button>
                             <button class="reject-btn text-red-600 hover:text-red-900">Reject</button>
                             <a href="${mailtoLink}" class="text-indigo-600 hover:text-indigo-900">Mail</a>
                         </td>
                     </tr>
                 `;
                 return; 
             }
             try {
                 const q = query(collection(db, "users"), where("status", "==", "pending"));
                 const querySnapshot = await getDocs(q);
                 applicationsTableBody.innerHTML = '';
                 if(querySnapshot.empty) {
                     applicationsTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No pending applications.</td></tr>`;
                     return;
                 }
                 querySnapshot.forEach((docSnap) => {
                     const applicant = docSnap.data();
                     const tr = document.createElement('tr');
                     const mailtoLink = `mailto:${applicant.email}?subject=${encodeURIComponent("Update on your Docgineer Labs Application")}&body=${encodeURIComponent(`Dear ${applicant.fullName},\n\nThank you for your interest in Docgineer Labs.\n\nBest regards,\nThe Docgineer Labs Team`)}`;
                     tr.innerHTML = `
                         <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-slate-900">${applicant.fullName}</div><div class="text-sm text-slate-500">${applicant.email}</div></td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${applicant.position}</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${applicant.branch}</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                             <button class="view-btn text-blue-600 hover:text-blue-900" data-id="${docSnap.id}">View</button>
                             <button class="grant-btn text-green-600 hover:text-green-900" data-id="${docSnap.id}" data-name="${applicant.fullName}" data-email="${applicant.email}">Grant</button>
                             <button class="reject-btn text-red-600 hover:text-red-900" data-id="${docSnap.id}">Reject</button>
                             <a href="${mailtoLink}" class="text-indigo-600 hover:text-indigo-900">Mail</a>
                         </td>
                     `;
                     applicationsTableBody.appendChild(tr);
                 });
               } catch(error) {
                 console.error("Error loading applications: ", error);
                 applicationsTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error loading applications.</td></tr>`;
               }
        }
        
        async function loadUsers(isPreview = false) {
            employeesTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">Loading employees...</td></tr>`;
            
            // Preview Mode
            if(isPreview) { 
                 employeesTableBody.innerHTML = `
                     <tr>
                          <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-slate-900">John Doe (Sample)</div></td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">Computer Science (CSE)</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">Engineer</td>
                          <td class="px-6 py-4 whitespace-nowrap text-center"><button class="text-blue-600 hover:text-blue-900"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg></button></td>
                          <td class="px-6 py-4 whitespace-nowrap">
                             <div class="flex items-center gap-3">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" disabled>
                                    <div class="w-9 h-5 bg-gray-200 rounded-full peer peer-checked:bg-green-600"></div>
                                </label>
                                <input type="text" placeholder="Private Link..." class="text-xs border border-slate-300 rounded px-2 py-1 w-32" disabled>
                             </div>
                          </td>
                          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900">Edit</button></td>
                     </tr>
                 `;
                 return;
            }

            // Real Data Logic
            try {
                const q = query(collection(db, "users"), where("role", "==", "employee"), where("status", "==", "active"));
                const querySnapshot = await getDocs(q);
                employeesTableBody.innerHTML = '';
                allEmployeeEmails = [];

                if (querySnapshot.empty) {
                    employeesTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">No active employees found.</td></tr>`;
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const user = docSnap.data();
                    allEmployeeEmails.push(user.email);
                    
                    const toggleId = `toggle-${docSnap.id}`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-slate-900">${user.fullName || user.name}</div>
                            <div class="text-xs text-slate-500">${user.email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${user.branch || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${user.position || 'Employee'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button class="message-user-btn text-blue-600 hover:text-blue-900" data-id="${docSnap.id}" data-name="${user.fullName || user.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                            </button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="${toggleId}" class="sr-only peer employee-meet-toggle" data-id="${docSnap.id}">
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                                </label>

                                <input type="text" id="meet-input-${docSnap.id}" placeholder="Private Link..." class="text-xs border border-slate-300 rounded px-2 py-1 w-32 focus:w-48 transition-all focus:ring-2 focus:ring-green-500 focus:outline-none">
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                             <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${docSnap.id}">Edit</button>
                        </td>
                    `;
                    employeesTableBody.appendChild(tr);
                    
                    // Set initial toggle state
                    getDoc(doc(db, "meetingSignals", docSnap.id)).then(snap => {
                        if(snap.exists() && snap.data().status === 'active') {
                             const toggleEl = document.getElementById(toggleId);
                             const inputEl = document.getElementById(`meet-input-${docSnap.id}`);
                             if(toggleEl) toggleEl.checked = true;
                             if(inputEl) inputEl.value = snap.data().link || '';
                        }
                    });
                });
            } catch(error) {
                console.error("Error loading users: ", error);
                employeesTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading employees.</td></tr>`;
            }
        }

        async function loadMembers(isPreview = false) {
            membersTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">Loading members...</td></tr>`;
            if (isPreview) {
                // ... (Preview logic skipped for brevity, similar to employees)
                return;
            }
            try {
                const q = query(collection(db, "users"), where("role", "==", "member"));
                const querySnapshot = await getDocs(q);
                membersTableBody.innerHTML = '';
                allMemberEmails = [];
                if (querySnapshot.empty) {
                    membersTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">No members found.</td></tr>`;
                    return;
                }
                querySnapshot.forEach((docSnap) => {
                    const user = docSnap.data();
                    allMemberEmails.push(user.email);
                    const toggleId = `toggle-member-${docSnap.id}`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-medium text-slate-900">${user.fullName || user.name || 'Member'}</div>
                            <div class="text-xs text-slate-500">${user.email}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">${user.contact || '-'}</td>
                        <td class="px-6 py-4 text-center">
                            <button class="message-user-btn text-blue-600 hover:text-blue-900" data-id="${docSnap.id}" data-name="${user.fullName || user.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                            </button>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="${toggleId}" class="sr-only peer employee-meet-toggle" data-id="${docSnap.id}">
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                                </label>
                                <input type="text" id="meet-input-${docSnap.id}" placeholder="Private Link..." class="text-xs border border-slate-300 rounded px-2 py-1 w-32 focus:w-48 transition-all focus:ring-2 focus:ring-green-500 focus:outline-none">
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                             <button class="edit-btn text-indigo-600 hover:text-indigo-900 text-sm font-medium" data-id="${docSnap.id}">Edit</button>
                        </td>
                    `;
                    membersTableBody.appendChild(tr);

                    // Set initial state for members too
                    getDoc(doc(db, "meetingSignals", docSnap.id)).then(snap => {
                        if(snap.exists() && snap.data().status === 'active') {
                             const toggleEl = document.getElementById(toggleId);
                             const inputEl = document.getElementById(`meet-input-${docSnap.id}`);
                             if(toggleEl) toggleEl.checked = true;
                             if(inputEl) inputEl.value = snap.data().link || '';
                        }
                    });
                });
            } catch (error) {
                console.error("Error loading members: ", error);
                membersTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading members.</td></tr>`;
            }
        }
        
        async function loadIdeas(isPreview = false) {
            membersIdeasContainer.innerHTML = '<p class="text-slate-500 col-span-full text-center p-4">Loading idea submissions...</p>';
            if (isPreview) {
                membersIdeasContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-5 flex flex-col">
                        <div class="flex justify-between items-start">
                            <div><p class="font-bold text-slate-800">Jane Smith (Sample)</p><p class="text-xs text-slate-500">Oct 20, 2025, 2:58:00 AM</p></div>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 text-blue-800">new</span>
                        </div>
                        <p class="text-sm text-slate-600 mt-3 mb-4 flex-grow">This is a sample idea submission...</p>
                        <div class="mt-auto border-t border-slate-200 pt-4"><div class="flex gap-2"><button data-id="sample-id" data-status="granted" class="grant-btn flex-1 bg-green-100 text-green-800 px-3 py-1.5 rounded-md text-xs font-semibold hover:bg-green-200">Grant</button><button data-id="sample-id" data-status="rejected" class="reject-btn flex-1 bg-red-100 text-red-800 px-3 py-1.5 rounded-md text-xs font-semibold hover:bg-red-200">Reject</button></div></div>
                    </div>
                `;
                return;
            }
            try {
                const ideaSnapshot = await getDocs(collection(db, "ideaSubmissions"));
                membersIdeasContainer.innerHTML = '';
                if (ideaSnapshot.empty) {
                    membersIdeasContainer.innerHTML = '<p class="text-slate-500 col-span-full text-center p-4">No idea submissions found.</p>';
                    return;
                }
                ideaSnapshot.forEach(docSnap => {
                    const ideaData = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow p-5 flex flex-col';
                    const statusColors = { new: 'bg-blue-100 text-blue-800', granted: 'bg-green-100 text-green-800', rejected: 'bg-red-100 text-red-800' };
                    const statusColor = statusColors[ideaData.status] || 'bg-slate-100 text-slate-800';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div><p class="font-bold text-slate-800">${ideaData.userName || 'Anonymous'}</p><p class="text-xs text-slate-500">${ideaData.submittedAt ? new Date(ideaData.submittedAt.toDate()).toLocaleString() : 'N/A'}</p></div>
                            <span id="status-${docSnap.id}" class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor}">${ideaData.status}</span>
                        </div>
                        <p class="text-sm text-slate-600 mt-3 mb-4 flex-grow">${ideaData.description}</p>
                        <div class="mt-auto border-t border-slate-200 pt-4"><div class="flex gap-2"><button data-id="${docSnap.id}" data-status="granted" class="grant-btn flex-1 bg-green-100 text-green-800 px-3 py-1.5 rounded-md text-xs font-semibold hover:bg-green-200">Grant</button><button data-id="${docSnap.id}" data-status="rejected" class="reject-btn flex-1 bg-red-100 text-red-800 px-3 py-1.5 rounded-md text-xs font-semibold hover:bg-red-200">Reject</button></div></div>
                    `;
                    membersIdeasContainer.appendChild(card);
                });
            } catch (error) {
                console.error("Error loading ideas:", error);
                membersIdeasContainer.innerHTML = '<p class="text-red-500 col-span-full text-center p-4">Failed to load idea submissions.</p>';
            }
        }

        async function updateIdeaStatus(ideaId, status) {
            try {
                await updateDoc(doc(db, "ideaSubmissions", ideaId), { status });
                loadIdeas();
            } catch (error) {
                console.error("Error updating idea status:", error);
                alert("Failed to update idea status.");
            }
        }

        async function grantApplication(userId, userName, userEmail) {
            try {
                await updateDoc(doc(db, "users", userId), { status: 'active' });
                const mailtoLink = `mailto:${userEmail}?subject=${encodeURIComponent("Welcome to Docgineer Labs!")}&body=${encodeURIComponent(`Dear ${userName},\n\nCongratulations! Your application has been approved.\n\nBest regards,\nThe Docgineer Labs Team`)}`;
                window.location.href = mailtoLink;
                setTimeout(loadAllData, 500);
            } catch(error) {
                console.error("Error updating application status: ", error);
                alert("Failed to update status.");
            }
        }

        async function rejectApplication(userId) {
             try {
                await updateDoc(doc(db, "users", userId), { status: 'rejected' });
                alert(`Application has been rejected.`);
                loadAllData();
            } catch(error) {
                console.error("Error updating application status: ", error);
                alert("Failed to update status.");
            }
        }

        async function openEditModal(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (!userDoc.exists()) {
                    alert("User not found!");
                    return;
                }
                const userData = userDoc.data();
                editingUser.id = userId;
                editingUser.role = userData.role;
                editFullName.value = userData.fullName || '';
                editPosition.value = userData.position || '';
                editBranch.value = userData.branch || '';
                editUserModal.classList.remove('hidden');
            } catch(error) {
                console.error("Error fetching user data for edit:", error);
                alert("Could not load user data.");
            }
        }

        async function saveChanges() {
            if (!editingUser.id) return;
            saveChangesBtn.disabled = true;
            saveChangesBtn.textContent = 'Saving...';
            try {
                await updateDoc(doc(db, "users", editingUser.id), {
                    fullName: editFullName.value,
                    position: editPosition.value,
                    branch: editBranch.value
                });
                editUserModal.classList.add('hidden');
                if (editingUser.role === 'employee') {
                    loadUsers();
                } else {
                    loadMembers();
                }
            } catch (error) {
                console.error("Error saving changes:", error);
                alert("Failed to save changes.");
            } finally {
                saveChangesBtn.disabled = false;
                saveChangesBtn.textContent = 'Save Changes';
            }
        }

        async function openApplicationModal(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (!userDoc.exists()) {
                    alert("Applicant not found!");
                    return;
                }
                const applicant = userDoc.data();
                document.getElementById('modal-applicant-name').textContent = `${applicant.fullName} (${applicant.email})`;
                document.getElementById('modal-applicant-role').textContent = `${applicant.position} - ${applicant.branch}`;
                document.getElementById('modal-applicant-about').textContent = applicant.about || 'Not provided.';
                document.getElementById('modal-applicant-skills').textContent = applicant.skills || 'Not provided.';
                document.getElementById('modal-applicant-work').textContent = applicant.work || 'Not provided.';
                applicationDetailsModal.classList.remove('hidden');
            } catch (error) {
                console.error("Error fetching applicant data:", error);
                alert("Could not load applicant data.");
            }
        }
        
        // --- 100% CLEAN openMessageModal FUNCTION ---
        async function openMessageModal(id, name) {
            messageRecipient.id = id;
            messageRecipient.name = name;
            
            // Get new UI elements
            const messageModalTitle = document.getElementById('message-modal-title');
            const messagesContainer = document.getElementById('messages-container');
            const replyTextarea = document.getElementById('reply-textarea');
            const noMessagesText = document.getElementById('no-messages-text');

            // Reset UI
            messageModalTitle.textContent = `Chat with: ${name}`;
            replyTextarea.value = '';
            replyTextarea.style.height = 'auto'; // Reset textarea height
            messagesContainer.innerHTML = ''; // Clear old messages
            messagesContainer.appendChild(noMessagesText); // Add "No messages" text
            noMessagesText.textContent = 'Loading history...'; // Set loading text

            if (!auth.currentUser) {
                console.error("Authentication state not ready.");
                noMessagesText.textContent = "Could not verify user.";
                messageModal.classList.remove('hidden');
                return;
            }

            // --- Load Full Chat History ---
            const adminId = auth.currentUser.uid;
            const userId = id; // This is the recipient's ID

            try {
                // Query 1: Messages FROM Admin TO User
                const q1 = query(
                    collection(db, "messages"),
                    where("senderId", "==", adminId),
                    where("recipientId", "==", userId)
                );
                // Query 2: Messages FROM User TO Admin
                const q2 = query(
                    collection(db, "messages"),
                    where("senderId", "==", userId),
                    where("recipientId", "==", adminId)
                );

                // Get both sets of messages
                const [snapshot1, snapshot2] = await Promise.all([getDocs(q1), getDocs(q2)]);
                const allMessages = [...snapshot1.docs, ...snapshot2.docs];

                if (allMessages.length === 0) {
                    noMessagesText.textContent = 'No messages found.';
                    messageModal.classList.remove('hidden');
                    replyTextarea.focus();
                    return;
                }

                // Sort all messages by timestamp
                allMessages.sort((a, b) => {
                    const timeA = a.data().timestamp ? a.data().timestamp.toMillis() : 0;
                    const timeB = b.data().timestamp ? b.data().timestamp.toMillis() : 0;
                    return timeA - timeB; // Sort ascending (oldest first)
                });

                // --- Render messages with new bubble logic ---
                messagesContainer.innerHTML = ''; // Clear loading text

                allMessages.forEach((docSnap) => {
                    const messageData = docSnap.data();
                    
                    // Admin's message will have senderId === adminId
                    const isMyMessage = messageData.senderId === adminId;

                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'} w-full`;

                    const messageDiv = document.createElement('div');
                    messageDiv.className = `max-w-xs md:max-w-md p-3 rounded-xl shadow-sm ${isMyMessage ? 'bg-indigo-600 text-white' : 'bg-white text-slate-900 border border-slate-200'}`;

                    const timestamp = messageData.timestamp
                        ? new Date(messageData.timestamp.toDate()).toLocaleString()
                        : 'No date';

                    let senderNameHTML = '';
                    if (!isMyMessage) {
                        // Show the user's name on their bubbles
                        senderNameHTML = `<div class="text-xs font-bold text-indigo-600 mb-1">${messageData.senderName || name}</div>`;
                    }
                    
                    messageDiv.innerHTML = `
                        ${senderNameHTML}
                        <p class="text-sm whitespace-pre-wrap">${messageData.content || ''}</p>
                        <div class="text-xs text-right mt-1 ${isMyMessage ? 'text-indigo-200' : 'text-slate-500'}">${timestamp}</div>
                    `;

                    messageWrapper.appendChild(messageDiv);
                    messagesContainer.appendChild(messageWrapper);
                });
                
                // Scroll to the bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error("Error loading message history:", error);
                noMessagesText.textContent = "Could not load history. You may need to create a Firestore index.";
                // Show the error in the console with the link
                if (error.message.includes("requires an index")) {
                    console.error("Index required! Create it here: " + error.message.substring(error.message.indexOf("https")));
                }
            }

            // Show Modal
            messageModal.classList.remove('hidden');
            replyTextarea.focus();
        }

        // --- 100% CLEAN sendMessage FUNCTION ---
        async function sendMessage() {
            // Get new element IDs
            const messageModalTextarea = document.getElementById('reply-textarea'); 
            const messagesContainer = document.getElementById('messages-container');
            const content = messageModalTextarea.value.trim();
            // File logic is not implemented for these buttons yet

            if (!content) {
                // No alert, just don't send an empty message
                return;
            }
            if (!messageRecipient.id || !auth.currentUser) {
                alert("Error: Recipient or sender not defined.");
                return;
            }

            const sendMessageBtn = document.getElementById('send-message-btn');
            sendMessageBtn.disabled = true;
            // Don't change text content of an icon button

            try {
                // Prepare message data
                const messageData = {
                    senderId: auth.currentUser.uid,
                    senderName: currentAdminProfile?.fullName || 'Admin',
                    recipientId: messageRecipient.id,
                    recipientName: messageRecipient.name,
                    content: content,
                    timestamp: serverTimestamp(),
                    isRead: false,
                };

                const docRef = await addDoc(collection(db, "messages"), messageData);

                // --- Add message instantly to the modal history ---
                const sentTime = new Date();
                
                // Add bubble logic to instant update
                const messageWrapper = document.createElement('div');
                messageWrapper.className = 'flex justify-end w-full'; // Admin's message

                const msgDiv = document.createElement('div');
                msgDiv.className = 'max-w-xs md:max-w-md p-3 rounded-xl shadow-sm bg-indigo-600 text-white'; // Admin's bubble color
                
                msgDiv.innerHTML = `
                    <p class="text-sm whitespace-pre-wrap">${content}</p>
                    <p class="text-xs text-right mt-1 text-indigo-200">${sentTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })} on ${sentTime.toLocaleDateString()}</p>
                `;
                
                messageWrapper.appendChild(msgDiv);
                
                // Find and remove the "No messages" text
                const noHistoryText = messagesContainer.querySelector('#no-messages-text');
                if (noHistoryText) noHistoryText.remove();
                
                messagesContainer.appendChild(messageWrapper);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                // --- End of instant update ---

            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message.");
            } finally {
                // Reset only the input fields
                messageModalTextarea.value = '';
                messageModalTextarea.style.height = 'auto'; // Reset height
                sendMessageBtn.disabled = false;
                messageModalTextarea.focus();
            }
        }
        
        // --- EVENT LISTENERS ---

        function setupEventListeners() {
            const closeModal = (modal) => modal.classList.add('hidden');

            // --- Modal Close Buttons & Background Click ---
            messageModalCloseBtn.addEventListener('click', () => closeModal(messageModal));
            messageModal.addEventListener('click', (e) => e.target === messageModal && closeModal(messageModal));

            modalCloseBtn.addEventListener('click', () => closeModal(applicationDetailsModal));
            applicationDetailsModal.addEventListener('click', (e) => e.target === applicationDetailsModal && closeModal(applicationDetailsModal));

            editModalCloseBtn.addEventListener('click', () => closeModal(editUserModal));
            editUserModal.addEventListener('click', (e) => e.target === editUserModal && closeModal(editUserModal));

            // --- Modal Action Buttons ---
            sendMessageBtn.addEventListener('click', sendMessage); // Calls the updated sendMessage function
            saveChangesBtn.addEventListener('click', saveChanges); // Calls the saveChanges function for the edit modal

            // --- REMOVED old file input listener that was causing an error ---

            // --- Group Action Buttons ---
            // Opens the message modal pre-filled for sending to all employees
            messageGroupBtn.addEventListener('click', () => openMessageModal('all_employees', 'All Employees'));
            // Opens the message modal pre-filled for sending to all members
            messageGroupBtnMembers.addEventListener('click', () => openMessageModal('all_members', 'All Members'));

           // --- MASTER SWITCH LOGIC ---
            const meetToggle = document.getElementById('meet-toggle');
            const meetStatusText = document.getElementById('meet-status-text');
            const permanentLinkInput = document.getElementById('permanent-link-input');
            const updateLinkBtn = document.getElementById('update-link-btn');
            
            let currentStoredLink = ''; // Holds the link even when off

            // 1. Load Settings on Page Load
            async function loadMeetingSettings() {
                try {
                    const docSnap = await getDoc(doc(db, "system", "meeting"));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Load the text (Use storedLink if available, else staticLink)
                        currentStoredLink = data.storedLink || data.staticLink || '';
                        permanentLinkInput.value = currentStoredLink;

                        // Check status: If staticLink is NOT null, it's ON
                        if (data.staticLink) {
                            meetToggle.checked = true;
                            meetStatusText.textContent = "ON";
                            permanentLinkInput.classList.remove('opacity-50');
                        } else {
                            meetToggle.checked = false;
                            meetStatusText.textContent = "OFF";
                            permanentLinkInput.classList.add('opacity-50');
                        }
                    }
                } catch (e) {
                    console.error("Error loading settings:", e);
                }
            }
            loadMeetingSettings();

            // 2. Handle Toggle Switch (ON/OFF)
            meetToggle.addEventListener('change', async () => {
                const isTurningOn = meetToggle.checked;
                const linkVal = permanentLinkInput.value.trim();

                meetToggle.disabled = true; // Prevent spam clicking

                try {
                    if (isTurningOn) {
                        // CASE: Turning ON
                        if (!linkVal.startsWith('http')) {
                            alert("Please enter a valid Link first!");
                            meetToggle.checked = false; // Flip back
                            meetToggle.disabled = false;
                            return;
                        }
                        // Save as Active
                        await setDoc(doc(db, "system", "meeting"), {
                            staticLink: linkVal,   // LIVE for users
                            storedLink: linkVal,   // Saved for admin
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        meetStatusText.textContent = "ON";
                        permanentLinkInput.classList.remove('opacity-50');
                        alert("Meeting is LIVE!");

                    } else {
                        // CASE: Turning OFF
                        // Save null to staticLink (Hides from users), but keep storedLink
                        await setDoc(doc(db, "system", "meeting"), {
                            staticLink: null,      // HIDDEN from users
                            storedLink: linkVal,   // Saved for admin
                            updatedAt: serverTimestamp()
                        }, { merge: true });

                        meetStatusText.textContent = "OFF";
                        permanentLinkInput.classList.add('opacity-50');
                    }
                } catch (e) {
                    console.error("Error toggling:", e);
                    alert("Failed to update status.");
                    meetToggle.checked = !isTurningOn; // Revert visually
                } finally {
                    meetToggle.disabled = false;
                }
            });

            // 3. Handle "UPDATE" Button (For changing link while ON/OFF)
            updateLinkBtn.addEventListener('click', async () => {
                const linkVal = permanentLinkInput.value.trim();
                const isOn = meetToggle.checked;

                if (!linkVal.startsWith('http')) {
                    alert("Please enter a valid URL.");
                    return;
                }

                updateLinkBtn.textContent = "...";
                try {
                    // Update storedLink regardless. Update staticLink only if ON.
                    const dataToSave = {
                        storedLink: linkVal,
                        updatedAt: serverTimestamp()
                    };
                    if (isOn) {
                        dataToSave.staticLink = linkVal;
                    }

                    await setDoc(doc(db, "system", "meeting"), dataToSave, { merge: true });
                    alert("Link Updated!");
                } catch (e) {
                    console.error("Error updating link:", e);
                } finally {
                    updateLinkBtn.textContent = "UPDATE";
                }
            });

           // 4. "Start Meeting" Button Logic (CREATE NEW MEETING)
            // This restores the function to OPEN A NEW MEETING TAB for both sections.
            
            const empBtn = document.getElementById('start-employee-meet-btn');
            const memBtn = document.getElementById('start-group-meet-btn-members');

            const startNewMeeting = (e) => {
                e.preventDefault();
                // Opens a fresh Google Meet where YOU are the Host
                window.open('https://meet.google.com/new', '_blank');
            };

            // Fix Employee Button
            if (empBtn) {
                const newEmpBtn = empBtn.cloneNode(true);
                empBtn.parentNode.replaceChild(newEmpBtn, empBtn);
                newEmpBtn.addEventListener('click', startNewMeeting);
            }

            // Fix Member Button
            if (memBtn) {
                const newMemBtn = memBtn.cloneNode(true);
                memBtn.parentNode.replaceChild(newMemBtn, memBtn);
                newMemBtn.addEventListener('click', startNewMeeting);
            }
            // --- NEW: Handle INDIVIDUAL Employee Toggles ---
            // using event delegation since rows are dynamic
            document.body.addEventListener('change', async (e) => {
                if (e.target.classList.contains('employee-meet-toggle')) {
                    const toggle = e.target;
                    const userId = toggle.dataset.id;
                    const inputField = document.getElementById(`meet-input-${userId}`);
                    const linkVal = inputField.value.trim();
                    const isTurningOn = toggle.checked;

                    // 1. SAFETY CHECK: PREVENT ON IF EMPTY
                    if (isTurningOn) {
                        if (!linkVal || !linkVal.startsWith('http')) {
                            alert("Cannot turn ON: Please enter a valid Link first!");
                            toggle.checked = false; // Snap back to OFF
                            return;
                        }
                    }

                    toggle.disabled = true; // Temporary disable while processing

                    try {
                        // 2. Update Firestore
                        // We use the 'meetingSignals' collection to store the persistent state per user
                        await setDoc(doc(db, "meetingSignals", userId), {
                            status: isTurningOn ? 'active' : 'inactive',
                            link: linkVal,
                            type: 'private_channel', // Tagging this as a channel, not just a call
                            updatedAt: serverTimestamp()
                        }, { merge: true });

                        console.log(`User ${userId} meeting channel is now ${isTurningOn ? 'ON' : 'OFF'}`);

                    } catch (error) {
                        console.error("Error updating toggle:", error);
                        alert("Database error. Check console.");
                        toggle.checked = !isTurningOn; // Revert visually on error
                    } finally {
                        toggle.disabled = false;
                    }
                }
            });
            // --- NEW: MEMBER MASTER SWITCH & MAGIC SYNC ---
            const memberMeetToggle = document.getElementById('member-meet-toggle');
            const memberMeetStatusText = document.getElementById('member-meet-status-text');
            const memberMasterInput = document.getElementById('member-permanent-link-input');
            const memberUpdateLinkBtn = document.getElementById('member-update-link-btn');

            // 1. Magic Sync for Members (Copy link to all member boxes)
            if (memberMasterInput) {
                memberMasterInput.addEventListener('input', function() {
                    const masterLink = this.value;
                    const memberInputs = document.querySelectorAll('#members-table-body input[id^="meet-input-"]');
                    memberInputs.forEach(input => {
                        input.value = masterLink;
                    });
                });
            }

            // 2. Load Member Settings
            async function loadMemberMeetingSettings() {
                try {
                    const docSnap = await getDoc(doc(db, "system", "member_meeting"));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const storedLink = data.storedLink || data.staticLink || '';
                        memberMasterInput.value = storedLink;
                        if (data.staticLink) {
                            memberMeetToggle.checked = true;
                            memberMeetStatusText.textContent = "ON";
                            memberMasterInput.classList.remove('opacity-50');
                        } else {
                            memberMeetToggle.checked = false;
                            memberMeetStatusText.textContent = "OFF";
                            memberMasterInput.classList.add('opacity-50');
                        }
                    }
                } catch (e) { console.error("Error loading member settings:", e); }
            }
            loadMemberMeetingSettings();

            // 3. Member Toggle Switch Logic
            memberMeetToggle.addEventListener('change', async () => {
                const isTurningOn = memberMeetToggle.checked;
                const linkVal = memberMasterInput.value.trim();
                memberMeetToggle.disabled = true;

                try {
                    if (isTurningOn) {
                        if (!linkVal.startsWith('http')) {
                            alert("Please enter a valid Link first!");
                            memberMeetToggle.checked = false;
                            memberMeetToggle.disabled = false;
                            return;
                        }
                        await setDoc(doc(db, "system", "member_meeting"), {
                            staticLink: linkVal,
                            storedLink: linkVal,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        memberMeetStatusText.textContent = "ON";
                        memberMasterInput.classList.remove('opacity-50');
                        alert("Member Meeting is LIVE!");
                    } else {
                        await setDoc(doc(db, "system", "member_meeting"), {
                            staticLink: null,
                            storedLink: linkVal,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        memberMeetStatusText.textContent = "OFF";
                        memberMasterInput.classList.add('opacity-50');
                    }
                } catch (e) {
                    console.error("Error toggling member meet:", e);
                    alert("Failed to update status.");
                    memberMeetToggle.checked = !isTurningOn;
                } finally {
                    memberMeetToggle.disabled = false;
                }
            });

            // 4. Member Update Button Logic
            memberUpdateLinkBtn.addEventListener('click', async () => {
                const linkVal = memberMasterInput.value.trim();
                const isOn = memberMeetToggle.checked;
                if (!linkVal.startsWith('http')) { alert("Please enter a valid URL."); return; }
                
                memberUpdateLinkBtn.textContent = "...";
                try {
                    const dataToSave = { storedLink: linkVal, updatedAt: serverTimestamp() };
                    if (isOn) dataToSave.staticLink = linkVal;
                    await setDoc(doc(db, "system", "member_meeting"), dataToSave, { merge: true });
                    alert("Member Link Updated!");
                } catch (e) { console.error(e); } 
                finally { memberUpdateLinkBtn.textContent = "UPDATE"; }
            });

            // --- Event Delegation for Dynamic Buttons in Tables & Idea Cards --
                document.body.addEventListener('click', async (e) => {
                const button = e.target.closest('button'); // Find the nearest button ancestor
                if (!button) return; // Exit if the click wasn't on or inside a button

                const userId = button.dataset.id; // Get user ID if present
                const ideaId = button.dataset.id; // Also used for idea ID

                // --- Buttons within the Applications Table ---
                if (button.classList.contains('view-btn')) {
                    if (userId) openApplicationModal(userId); // Check userId exists
                } else if (button.classList.contains('grant-btn') && button.closest('#applications-table-body')) { // Check it's an application grant btn
                     if (userId && confirm(`Are you sure you want to grant this application?`)) {
                         grantApplication(userId, button.dataset.name, button.dataset.email);
                     }
                } else if (button.classList.contains('reject-btn') && button.closest('#applications-table-body')) { // Check it's an application reject btn
                     if (userId && confirm(`Are you sure you want to reject this application?`)) {
                         rejectApplication(userId);
                     }
                }
                // --- Buttons within the Employee/Member Tables ---
                else if (button.classList.contains('message-user-btn')) {
                     if (userId) openMessageModal(userId, button.dataset.name); // Check userId exists
                } else if (button.classList.contains('edit-btn')) {
                     if (userId) openEditModal(userId); // Check userId exists
                }
                // --- Buttons within the Idea Submission Cards ---
                else if (button.classList.contains('grant-btn') && button.closest('#members-ideas-container')) { // Check it's an idea grant btn
                    const status = button.dataset.status;
                    if (ideaId && status && confirm(`Are you sure you want to ${status} this idea?`)) {
                        updateIdeaStatus(ideaId, status);
                    }
                } else if (button.classList.contains('reject-btn') && button.closest('#members-ideas-container')) { // Check it's an idea reject btn
                    const status = button.dataset.status;
                     if (ideaId && status && confirm(`Are you sure you want to ${status} this idea?`)) {
                         updateIdeaStatus(ideaId, status);
                     }
                }
            });
        } // End of setupEventListeners function
        
        // Initial setup
        setupEventListeners();
    });
    // --- NEW: EMPLOYEE-ONLY SYNC & INSTANT MEET ---

            // 1. "Magic Sync" - Copies Top Link to EMPLOYEE boxes ONLY
            const masterInput = document.getElementById('permanent-link-input');
            
            if (masterInput) {
                masterInput.addEventListener('input', function() {
                    const masterLink = this.value;
                    
                    // SELECTOR UPDATE: Only look inside 'employees-table-body'
                    const employeeInputs = document.querySelectorAll('#employees-table-body input[id^="meet-input-"]');
                    
                    employeeInputs.forEach(input => {
                        input.value = masterLink;
                    });
                });
            }

            // 2. "Instant Meet" - Opens a fresh meeting for Employees
            const startEmpBtn = document.getElementById('start-employee-meet-btn');
            
            if (startEmpBtn) {
                startEmpBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Opens a fresh Google Meet instantly
                    window.open('https://meet.google.com/new', '_blank');
                });
            }
</script>

</body>
</html>

